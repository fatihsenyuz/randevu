<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Royal Premium Care Randevu Takip Sistemi</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .modal {
            transition: opacity 0.25s ease;
        }
        body, html {
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .bg-royal-blue {
            background-color: #1e3a8a;
        }
        .text-royal-blue {
            color: #1e3a8a;
        }
        .border-royal-blue {
            border-color: #1e3a8a;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="bg-royal-blue text-white p-4 rounded-lg shadow-lg mb-6">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold">Royal Premium Care</h1>
                <h2 class="text-xl">Randevu Takip Sistemi</h2>
            </div>
        </header>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column: Appointment Form -->
            <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-bold mb-4 text-royal-blue">Yeni Randevu Oluştur</h2>
                <form id="appointmentForm" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="customerName">İsim Soyisim</label>
                        <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="customerName" type="text" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="customerPhone">Telefon Numarası</label>
                        <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="customerPhone" type="tel" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="customerAddress">Adres</label>
                        <textarea class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="customerAddress" rows="3" required></textarea>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="appointmentDate">Tarih</label>
                        <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="appointmentDate" type="date" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="appointmentTime">Saat</label>
                        <select class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="appointmentTime" required>
                            <option value="">Saat Seçiniz</option>
                            <!-- Saat seçenekleri JavaScript ile doldurulacak -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="serviceSelect">Hizmet</label>
                        <select class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="serviceSelect" required>
                            <option value="">Hizmet Seçiniz</option>
                            <!-- Hizmet seçenekleri JavaScript ile doldurulacak -->
                        </select>
                    </div>
                    <button class="bg-royal-blue hover:bg-blue-800 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full" type="submit">
                        Randevu Oluştur
                    </button>
                </form>
            </div>

            <!-- Middle Column: Active Appointments -->
            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-royal-blue">Aktif Randevular</h2>
                    <div>
                        <button id="customersBtn" class="bg-royal-blue hover:bg-blue-800 text-white font-bold py-1 px-3 rounded text-sm">
                            Müşteriler
                        </button>
                    </div>
                </div>
                <div id="appointmentList" class="space-y-4">
                    <!-- Randevular burada listelenecek -->
                </div>
            </div>
        </div>

        <!-- Add Service Modal -->
        <div id="addServiceModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
            <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
            
            <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto">
                <div class="modal-content py-4 text-left px-6">
                    <div class="flex justify-between items-center pb-3">
                        <p class="text-xl font-bold text-royal-blue">Yeni Hizmet Ekle</p>
                        <div class="modal-close cursor-pointer z-50">
                            <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18">
                                <path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path>
                            </svg>
                        </div>
                    </div>

                    <form id="serviceForm" class="space-y-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="serviceName">Hizmet Adı</label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="serviceName" type="text" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="serviceDuration">Süre (dakika)</label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="serviceDuration" type="number" min="15" step="15" required>
                        </div>
                        <div class="flex justify-end pt-2">
                            <button class="bg-royal-blue hover:bg-blue-800 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="submit">
                                Hizmet Ekle
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-8 text-center">
            <button id="addServiceBtn" class="bg-royal-blue hover:bg-blue-800 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                <i class="fas fa-plus mr-2"></i>Yeni Hizmet Ekle
            </button>
        </footer>
    </div>

    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.17.2/firebase-app-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.17.2/firebase-database-compat.js"></script>
    
    <script>
        // Firebase yapılandırma
        const firebaseConfig = {
          apiKey: "AIzaSyCkDVD0MIZUy4tdLrWJDONYWlt0kXA2xuU",
          authDomain: "royal-6ff68.firebaseapp.com",
          databaseURL: "https://royal-6ff68-default-rtdb.europe-west1.firebasedatabase.app/",
          projectId: "royal-6ff68",
          storageBucket: "royal-6ff68.appspot.com",
          messagingSenderId: "1056928171234",
          appId: "1:1056928171234:web:abcd1234efgh5678ijkl90",
          measurementId: "G-XYZ123ABC"
        };
        
        // Firebase'i başlat
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Veri yapısı
        let services = [
            { id: 1, name: "Koltuk Takımı Yıkama", duration: 120 },
            { id: 2, name: "Yatak Yıkama", duration: 60 },
            { id: 3, name: "Sandalye Yıkama", duration: 30 }
        ];
        
        let appointments = [];
        let customers = [];
        
        // DOM elementlerini seçme
        const appointmentForm = document.getElementById('appointmentForm');
        const serviceForm = document.getElementById('serviceForm');
        const addServiceBtn = document.getElementById('addServiceBtn');
        const addServiceModal = document.getElementById('addServiceModal');
        const modalClose = document.querySelector('.modal-close');
        const serviceSelect = document.getElementById('serviceSelect');
        const appointmentTimeSelect = document.getElementById('appointmentTime');
        const appointmentList = document.getElementById('appointmentList');
        const customersBtn = document.getElementById('customersBtn');
        
        // Sayfa yüklendiğinde
        document.addEventListener('DOMContentLoaded', () => {
            // Servis seçeneklerini doldur
            populateServiceOptions();
            
            // Saat seçeneklerini doldur
            populateTimeOptions();
            
            // Tarihi bugün olarak ayarla
            document.getElementById('appointmentDate').valueAsDate = new Date();
            
            // Firebase'den verileri yükle
            loadFromFirebase();
            
            // Müşteriler butonuna tıklama dinleyicisi ekle
            customersBtn.addEventListener('click', showCustomers);
        });
        
        // Servis seçeneklerini doldur
        function populateServiceOptions() {
            serviceSelect.innerHTML = '<option value="">Hizmet Seçiniz</option>';
            services.forEach(service => {
                const option = document.createElement('option');
                option.value = service.id;
                option.textContent = `${service.name} (${service.duration} dk)`;
                serviceSelect.appendChild(option);
            });
        }
        
        // Saat seçeneklerini doldur
        function populateTimeOptions() {
            appointmentTimeSelect.innerHTML = '<option value="">Saat Seçiniz</option>';
            for (let hour = 8; hour < 20; hour++) {
                for (let minute of ['00', '30']) {
                    const timeValue = `${hour.toString().padStart(2, '0')}:${minute}`;
                    const option = document.createElement('option');
                    option.value = timeValue;
                    option.textContent = timeValue;
                    appointmentTimeSelect.appendChild(option);
                }
            }
        }
        
        // Tarih formatlama
        function formatDate(dateString) {
            const date = new Date(dateString);
            const options = { day: 'numeric', month: 'long', weekday: 'long' };
            return date.toLocaleDateString('tr-TR', options);
        }
        
        // Randevuları göster
        function displayAppointments() {
            appointmentList.innerHTML = '';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Tarihe göre sırala
            const sortedAppointments = [...appointments].sort((a, b) => {
                const dateA = new Date(`${a.date}T${a.time}`);
                const dateB = new Date(`${b.date}T${b.time}`);
                return dateA - dateB;
            });
            
            // Bugünden sonraki randevuları filtrele
            const filteredAppointments = sortedAppointments.filter(appointment => {
                const appointmentDate = new Date(appointment.date);
                appointmentDate.setHours(0, 0, 0, 0);
                return appointmentDate.getTime() >= today.getTime();
            });
            
            if (filteredAppointments.length === 0) {
                appointmentList.innerHTML = '<p class="text-gray-500 text-center py-4">Aktif randevu bulunmamaktadır.</p>';
                return;
            }
            
            let currentDate = null;
            
            filteredAppointments.forEach(appointment => {
                const appointmentDate = new Date(appointment.date);
                appointmentDate.setHours(0, 0, 0, 0);
                
                // Tarih başlığını ekle
                if (!currentDate || currentDate.getTime() !== appointmentDate.getTime()) {
                    currentDate = appointmentDate;
                    const dateHeading = document.createElement('div');
                    dateHeading.className = 'bg-gray-100 p-2 rounded-t-lg font-bold text-royal-blue mt-4';
                    dateHeading.textContent = formatDate(appointment.date);
                    appointmentList.appendChild(dateHeading);
                }
                
                // Servis bilgilerini al
                const service = services.find(s => s.id === parseInt(appointment.serviceId));
                if (!service) return; // Servis bulunamazsa atla
                
                // Randevu bitiş saatini hesapla
                const [startHour, startMinute] = appointment.time.split(':').map(Number);
                const startTime = new Date();
                startTime.setHours(startHour, startMinute, 0, 0);
                
                const endTime = new Date(startTime);
                endTime.setMinutes(endTime.getMinutes() + service.duration);
                const endTimeStr = `${endTime.getHours().toString().padStart(2, '0')}:${endTime.getMinutes().toString().padStart(2, '0')}`;
                
                // Randevu kartını oluştur
                const appointmentCard = document.createElement('div');
                appointmentCard.className = 'border-l-4 border-royal-blue bg-white p-4 shadow-sm mb-2';
                appointmentCard.innerHTML = `
                    <div class="flex justify-between">
                        <div>
                            <h3 class="font-bold">${appointment.customerName}</h3>
                            <p class="text-sm text-gray-600">${appointment.customerPhone}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold">${appointment.time} - ${endTimeStr}</p>
                            <p class="text-sm text-gray-600">${service.name} (${service.duration} dk)</p>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1 truncate">${appointment.customerAddress}</p>
                    <div class="mt-2 text-right">
                        <button class="text-red-500 text-xs delete-appointment" data-id="${appointment.id}">
                            <i class="fas fa-trash-alt"></i> Sil
                        </button>
                    </div>
                `;
                
                // Silme butonuna olay dinleyicisi ekle
                appointmentList.appendChild(appointmentCard);
            });
            
            // Silme butonlarına olay dinleyicisi ekle
            document.querySelectorAll('.delete-appointment').forEach(button => {
                button.addEventListener('click', function() {
                    const appointmentId = this.getAttribute('data-id');
                    deleteAppointment(appointmentId);
                });
            });
        }
        
        // Müşterileri göster
        function showCustomers() {
            appointmentList.innerHTML = '';
            
            const title = document.createElement('div');
            title.className = 'bg-gray-100 p-2 rounded-t-lg font-bold text-royal-blue mt-4';
            title.textContent = 'Tüm Müşteriler';
            appointmentList.appendChild(title);
            
            // Benzersiz müşterileri bul
            const uniqueCustomers = [];
            const customerMap = {};
            
            appointments.forEach(appointment => {
                const key = `${appointment.customerName}-${appointment.customerPhone}`;
                if (!customerMap[key]) {
                    customerMap[key] = true;
                    uniqueCustomers.push({
                        name: appointment.customerName,
                        phone: appointment.customerPhone,
                        address: appointment.customerAddress
                    });
                }
            });
            
            // Müşterileri alfabetik sırala
            uniqueCustomers.sort((a, b) => a.name.localeCompare(b.name));
            
            if (uniqueCustomers.length === 0) {
                appointmentList.innerHTML += '<p class="text-gray-500 text-center py-4">Kayıtlı müşteri bulunmamaktadır.</p>';
                return;
            }
            
            uniqueCustomers.forEach(customer => {
                const customerCard = document.createElement('div');
                customerCard.className = 'border-l-4 border-green-500 bg-white p-4 shadow-sm mb-2';
                customerCard.innerHTML = `
                    <div>
                        <h3 class="font-bold">${customer.name}</h3>
                        <p class="text-sm text-gray-600">${customer.phone}</p>
                        <p class="text-xs text-gray-500 mt-1">${customer.address}</p>
                    </div>
                `;
                appointmentList.appendChild(customerCard);
            });
            
            // Geri dönüş butonu ekle
            const backButton = document.createElement('button');
            backButton.className = 'mt-4 bg-royal-blue hover:bg-blue-800 text-white font-bold py-2 px-4 rounded w-full';
            backButton.textContent = 'Randevulara Dön';
            backButton.addEventListener('click', () => {
                displayAppointments();
            });
            
            appointmentList.appendChild(backButton);
        }
        
        // Randevu oluşturma
        appointmentForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const customerName = document.getElementById('customerName').value;
            const customerPhone = document.getElementById('customerPhone').value;
            const customerAddress = document.getElementById('customerAddress').value;
            const appointmentDate = document.getElementById('appointmentDate').value;
            const appointmentTime = document.getElementById('appointmentTime').value;
            const serviceId = document.getElementById('serviceSelect').value;
            
            // Randevu çakışma kontrolü
            if (!isTimeSlotAvailable(appointmentDate, appointmentTime, serviceId)) {
                alert('Bu saat diliminde başka bir randevu bulunmaktadır.');
                return;
            }
            
            // Yeni randevu ekle
            const newAppointment = {
                id: Date.now().toString(),
                customerName,
                customerPhone,
                customerAddress,
                date: appointmentDate,
                time: appointmentTime,
                serviceId
            };
            
            // Firebase'e kaydet
            saveAppointmentToFirebase(newAppointment)
                .then(() => {
                    // Lokale de ekle
                    appointments.push(newAppointment);
                    
                    // Randevuları göster
                    displayAppointments();
                    
                    // Formu temizle
                    appointmentForm.reset();
                    document.getElementById('appointmentDate').valueAsDate = new Date();
                    
                    alert('Randevu başarıyla oluşturuldu.');
                })
                .catch(error => {
                    console.error("Randevu kaydedilirken hata oluştu:", error);
                    alert('Randevu oluşturulurken bir hata oluştu.');
                });
        });
        
        // Randevu silme
        function deleteAppointment(appointmentId) {
            if (confirm('Bu randevuyu silmek istediğinizden emin misiniz?')) {
                // Firebase'den sil
                database.ref('appointments/' + appointmentId).remove()
                    .then(() => {
                        // Lokalden de sil
                        appointments = appointments.filter(appointment => appointment.id !== appointmentId);
                        
                        // Randevuları tekrar göster
                        displayAppointments();
                        
                        alert('Randevu başarıyla silindi.');
                    })
                    .catch(error => {
                        console.error("Randevu silinirken hata oluştu:", error);
                        alert('Randevu silinirken bir hata oluştu.');
                    });
            }
        }
        
        // Randevu çakışma kontrolü
        function isTimeSlotAvailable(date, time, serviceId) {
            const selectedService = services.find(s => s.id === parseInt(serviceId));
            if (!selectedService) return false;
            
            const [startHour, startMinute] = time.split(':').map(Number);
            const startDateTime = new Date(date);
            startDateTime.setHours(startHour, startMinute, 0, 0);
            
            const endDateTime = new Date(startDateTime);
            endDateTime.setMinutes(endDateTime.getMinutes() + selectedService.duration);
            
            return !appointments.some(appointment => {
                if (appointment.date !== date) return false;
                
                const [existingStartHour, existingStartMinute] = appointment.time.split(':').map(Number);
                const existingStartDateTime = new Date(date);
                existingStartDateTime.setHours(existingStartHour, existingStartMinute, 0, 0);
                
                const existingService = services.find(s => s.id === parseInt(appointment.serviceId));
                if (!existingService) return false;
                
                const existingEndDateTime = new Date(existingStartDateTime);
                existingEndDateTime.setMinutes(existingEndDateTime.getMinutes() + existingService.duration);
                
                // Çakışma kontrolü
                return (
                    (startDateTime < existingEndDateTime && endDateTime > existingStartDateTime)
                );
            });
        }
        
        // Hizmet ekleme modalını aç
        addServiceBtn.addEventListener('click', () => {
            addServiceModal.classList.remove('opacity-0', 'pointer-events-none');
        });
        
        // Hizmet ekleme modalını kapat
        modalClose.addEventListener('click', () => {
            addServiceModal.classList.add('opacity-0', 'pointer-events-none');
        });
        
        // Hizmet ekleme
        serviceForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const serviceName = document.getElementById('serviceName').value;
            const serviceDuration = parseInt(document.getElementById('serviceDuration').value);
            
            // Yeni hizmet ekle
            const newService = {
                id: services.length > 0 ? Math.max(...services.map(s => s.id)) + 1 : 1,
                name: serviceName,
                duration: serviceDuration
            };
            
            // Firebase'e kaydet
            saveServiceToFirebase(newService)
                .then(() => {
                    // Lokale de ekle
                    services.push(newService);
                    
                    // Hizmet seçeneklerini güncelle
                    populateServiceOptions();
                    
                    // Modalı kapat
                    addServiceModal.classList.add('opacity-0', 'pointer-events-none');
                    
                    // Formu temizle
                    serviceForm.reset();
                    
                    alert('Hizmet başarıyla eklendi.');
                })
                .catch(error => {
                    console.error("Hizmet kaydedilirken hata oluştu:", error);
                    alert('Hizmet eklenirken bir hata oluştu.');
                });
        });
        
        // Firebase işlemleri
        
        // Firebase'den verileri yükle
        function loadFromFirebase() {
            // Hizmetleri yükle
            database.ref('services').once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const servicesData = snapshot.val();
                        services = Object.values(servicesData);
                        populateServiceOptions();
                    } else {
                        // Varsayılan hizmetleri Firebase'e kaydet
                        services.forEach(service => {
                            database.ref('services/' + service.id).set(service);
                        });
                    }
                })
                .catch(error => {
                    console.error("Hizmetler yüklenirken hata:", error);
                });
            
            // Randevuları yükle ve gerçek zamanlı dinle
            database.ref('appointments').on('value', snapshot => {
                if (snapshot.exists()) {
                    const appointmentsData = snapshot.val();
                    appointments = Object.values(appointmentsData);
                    displayAppointments();
                } else {
                    appointments = [];
                    displayAppointments();
                }
            });
        }
        
        // Randevuyu Firebase'e kaydet
        function saveAppointmentToFirebase(appointment) {
            return database.ref('appointments/' + appointment.id).set(appointment);
        }
        
        // Hizmeti Firebase'e kaydet
        function saveServiceToFirebase(service) {
            return database.ref('services/' + service.id).set(service);
        }
        
        // Firebase'den uygulamayı ayır (sayfa kapatılırken)
        window.addEventListener('beforeunload', () => {
            database.ref('appointments').off();
        });
    </script>
</body>
</html>